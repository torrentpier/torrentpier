<?php

if (!defined('BB_ROOT')) {
    die(basename(__FILE__));
}

$user->session_start();

$topic_id = (int)$_GET['t'];

$sql = 'SELECT t.attach_id, t.info_hash_v2, ad.physical_filename
        FROM ' . BB_BT_TORRENTS . ' t
        LEFT JOIN ' . BB_ATTACHMENTS_DESC . ' ad
        ON t.attach_id = ad.attach_id
        WHERE t.topic_id = ' . $topic_id . '
        LIMIT 1';

$row = DB()->fetch_row($sql);

if (empty($row) || empty($row['physical_filename'])) {
    http_response_code(404);
    die($lang['TOPIC_POST_NOT_EXIST']);
}

if (empty($row['info_hash_v2'])) {
    http_response_code(404);
    die('Currently torrents with BitTorrent v2 support are enabled for file listing');
}

$file_path = get_attachments_dir() . '/' . $row['physical_filename'];

if(!is_file($file_path)){
    die($lang['INVALID_ATTACH_ID']);
}

$file_contents = file_get_contents($file_path);

if (!$tor = \Arokettu\Bencode\Bencode::decode($file_contents, dictType: \Arokettu\Bencode\Bencode\Collection::ARRAY)) {
    die($lang['TORFILE_INVALID']);
}

$torrent = new TorrentPier\Legacy\TorrentFileList($tor);
$file_list = $torrent->fileTreeTable($tor['info']['file tree']);

$data = [
    'date' => '',
    'name' => htmlCHR($tor['info']['name'] ?? ''),
    'client' => htmlCHR(substr($tor['created by'] ?? 'unknown client', 0, 20)),
    'size' => humn_size($file_list['size'])
];

if (isset($tor['creation date']) && is_numeric($tor['creation date'])) {
    $data['date'] = date("d M Y | G:i:s T", $tor['creation date']);
}

echo "<html>
<head>
<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
<meta name=\"robots\" content=\"index, follow\">
<meta name=\"description\" content=\"File list for topic - $topic_id\">

<title>File list — {$data['name']} ({$data['size']})</title>
</head>
<body style=\"background-color: #1f1f1f; color: #ffffff;\">
<style>

    table {
        table-layout: auto;
        border-collapse: collapse;
        width: auto;
        margin: 20px auto;
        font-family: -apple-system,BlinkMacSystemFont,\"Segoe UI\",\"Noto Sans\",Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\";
        background-color: #2c2c2c;
        color: #ffffff;
    }

    th, td {
        border: 2px solid #00ff00;
        border-color: #646464;
        padding: 8px;
        text-align: left;
        color: #acacac;
    }

    th {
        background-color: #1f1f1f;
    }

    p {
        color: #b3b3b3;
    }

    a {
        color: #187700;
    }

</style>
<center>
<h2 style = \"color: #b3b3b3;font-family: Monospace\">Document name: {$data['name']} | Date: ({$data['date']}) | Size: {$data['size']}
</h2>
<p><i>Created by: {$data['client']}</i></p>
<hr>

<table><tr><th>Path</th><th>Size</th><th title=\"BitTorrent Merkle Root — The hash of the file, which is embedded in torrents with BitTorrent v2 support, tracker users can extract, calculate them, also deduplicate torrents using desktop tools such as Torrent Merkle Root Reader.\">Hash <sup>?</sup></th></tr>";

echo implode('', $file_list['list']);

echo '</center>
</table>
<p>Generated by <a href = "https://github.com/torrentpier/torrentpier" target="_blank">TorrentPier</a></p>
</body>
</html>';

die();
