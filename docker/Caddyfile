# Dynamic Caddy configuration based on environment variables
{
    auto_https off
}

# HTTP configuration (always available)
:{$TP_PORT:80} {
    root * /var/www/html
    encode gzip zstd
    php_fastcgi 127.0.0.1:9000
    try_files {path} {path}/ /index.php?{query}
    file_server

    @blocked {
        path /install/* /internal_data/* /library/*
        path /.ht* /.en*
        path /.git/*
        path *.sql *.tpl *.db *.inc *.log *.md
    }
    respond @blocked 404

    redir /sitemap.xml /sitemap/sitemap.xml

    @html_css_js {
        path *.html *.css *.js *.json *.xml *.txt
    }
    header @html_css_js Content-Type "{mime}; charset=utf-8"

    # Health check endpoint for load balancers
    respond /health 200

    # Redirect to HTTPS if SSL is enabled
    @ssl_enabled `{env.SSL_ENABLED} == "true"`
    redir @ssl_enabled https://{host}{uri} permanent
}

# HTTPS configuration (when SSL_ENABLED=true)
{$TP_HOST:localhost}:443 {
    @ssl_enabled `{env.SSL_ENABLED} == "true"`
    handle @ssl_enabled {
        root * /var/www/html
        encode gzip zstd
        php_fastcgi 127.0.0.1:9000
        try_files {path} {path}/ /index.php?{query}
        file_server

        @blocked {
            path /install/* /internal_data/* /library/*
            path /.ht* /.en*
            path /.git/*
            path *.sql *.tpl *.db *.inc *.log *.md
        }
        respond @blocked 404

        redir /sitemap.xml /sitemap/sitemap.xml

        @html_css_js {
            path *.html *.css *.js *.json *.xml *.txt
        }
        header @html_css_js Content-Type "{mime}; charset=utf-8"

        # TLS configuration
        tls {$SSL_EMAIL:internal}
    }

    @ssl_disabled `{env.SSL_ENABLED} != "true"`
    respond @ssl_disabled "SSL not enabled" 404
}
